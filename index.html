<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Profili Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico">
    
    <!-- Libreria per Esportazione/Importazione Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --colore-primario: #0146bc;
            --colore-secondario: #eddc01;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
        }
        .btn-primario {
            background-color: var(--colore-primario);
            color: white;
            transition: background-color 0.3s;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            font-weight: 500; /* medium */
            border: 2px solid var(--colore-primario);
        }
        .btn-primario:hover {
            background-color: #003a9a;
        }
        .btn-secondario {
            background-color: var(--colore-secondario);
            color: #333;
            transition: background-color 0.3s;
            border-radius: 0.375rem;
            padding: 0.625rem 1.25rem;
            font-weight: 500;
            border: 2px solid var(--colore-secondario);
        }
        .btn-secondario:hover {
            background-color: #d4c400;
        }
        .btn-outline {
            background-color: white;
            color: var(--colore-primario);
            border: 2px solid var(--colore-primario);
            transition: background-color 0.3s, color 0.3s;
            border-radius: 0.375rem;
            padding: 0.625rem 1.25rem;
            font-weight: 500;
        }
        .btn-outline:hover {
            background-color: var(--colore-primario);
            color: white;
        }
        .btn-danger {
            background-color: #DC2626; /* red-600 */
            color: white;
            transition: background-color 0.3s;
            border-radius: 0.375rem;
            padding: 0.625rem 1.25rem;
            font-weight: 500;
            border: 2px solid #DC2626;
        }
        .btn-danger:hover {
            background-color: #B91C1C; /* red-700 */
        }
        
        /* Stile per modali (popup) */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Toggle Switch */
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            background: white;
            border-radius: 9999px;
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.3s;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        input:checked + .toggle-bg {
            background-color: var(--colore-primario);
        }
        
        /* Stile bottoni ordinamento */
        .active-sort {
            background-color: var(--colore-primario) !important;
            color: white !important;
        }
        .controls-section button:not(.active-sort) {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        .controls-section button:not(.active-sort):hover {
            background-color: #e5e7eb; /* gray-200 */
        }

        /* Stile griglia card vista compatta */
        .card-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        /* Stile lista card vista completa (default) */
        .card-grid-full {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        /* Stili per le card */
        .profile-card-compact {
            padding: 1rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .profile-card-full {
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        .card-header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body style="--colore-primario: #0146bc; --colore-secondario: #eddc01;">

    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <header class="mb-6 p-6 bg-white rounded-lg shadow-md flex justify-between items-center" style="border-left: 5px solid var(--colore-primario);">
                <div>
                    <h1 class="text-3xl font-bold" style="color: var(--colore-primario);">Gestore Profili</h1>
                    <p class="text-gray-600">Database per profili social. (v1.1)</p>
                </div>
                <button id="add-profile-btn" class="btn-primario flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Aggiungi Profilo</span>
                </button>
            </header>

            <!-- Sezione Ricerca e Filtri -->
            <div class="mb-6 p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold mb-4" style="color: var(--colore-primario);">Ricerca e Filtri</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Ricerca Testuale -->
                    <input type="text" id="search-text" class="md:col-span-3 w-full p-2 border border-gray-300 rounded-md" placeholder="Cerca per nome, descrizione, account (usa E, O, NON per logica booleana)">
                    
                    <!-- Filtro Data -->
                    <input type="date" id="search-date-start" class="w-full p-2 border border-gray-300 rounded-md" title="Data Inizio Inserimento">
                    <input type="date" id="search-date-end" class="w-full p-2 border border-gray-300 rounded-md" title="Data Fine Inserimento">

                    <!-- Filtro Canali -->
                    <select id="search-channel" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Tutti i Canali</option>
                        <option value="x_name">X (Twitter)</option>
                        <option value="facebook_name">Facebook</option>
                        <option value="instagram_name">Instagram</option>
                        <option value="youtube_name">Youtube</option>
                        <option value="tiktok_name">TikTok</option>
                    </select>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button id="filter-btn" class="btn-primario">Applica Filtri</button>
                    <button id="reset-filter-btn" class="btn-outline">Resetta Filtri</button>
                </div>
            </div>

            <!-- Sezione Esportazione / Importazione -->
            <div class="mb-6 p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold mb-4" style="color: var(--colore-primario);">Strumenti</h2>
                <div class="flex flex-wrap gap-2">
                    <!-- Import JSON -->
                    <label class="btn-secondario cursor-pointer">
                        <span>Importa JSON</span>
                        <input type="file" id="import-json-btn" class="sr-only" accept=".json">
                    </label>
                    <!-- Import Excel -->
                    <label class="btn-secondario cursor-pointer">
                        <span>Importa Excel</span>
                        <input type="file" id="import-excel-btn" class="sr-only" accept=".xlsx, .xls">
                    </label>
                    <!-- Export -->
                    <button id="export-json-btn" class="btn-secondario">Esporta DB (JSON)</button>
                    <button id="export-excel-btn" class="btn-outline">Esporta Filtri (Excel)</button>
                    <button id="export-talkwalker-btn" class="btn-outline">Esporta Filtri (Talkwalker)</button>
                    <!-- Reset App -->
                    <button id="reset-app-btn" class="btn-danger">Resetta Applicazione</button>
                </div>
            </div>

            <!-- Controlli Vista e Ordinamento -->
            <div id="controls-section" class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm mb-4">
                <!-- Toggle Vista -->
                <div class="flex items-center">
                    <span class="mr-3 text-sm font-medium text-gray-900">Vista Compatta</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="view-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 toggle-bg"></div>
                    </label>
                </div>
                
                <!-- Ordinamento -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">Ordina per:</span>
                    <button id="sort-desc" class="p-2 rounded-md transition-colors active-sort" title="Più Recenti (Default)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3.75A.75.75 0 0110 3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="sort-asc" class="p-2 rounded-md transition-colors" title="Meno Recenti">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.56l-3.22 3.22a.75.75 0 11-1.06-1.06l4.5-4.5a.75.75 0 011.06 0l4.5 4.5a.75.75 0 01-1.06 1.06L10.75 5.56v10.69A.75.75 0 0110 17z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="sort-az" class="p-2 rounded-md transition-colors font-bold text-sm" title="Alfabetico (A-Z)">
                        A-Z
                    </button>
                </div>
            </div>

            <!-- Lista Profili -->
            <div id="profile-list" class="card-grid-full">
                <!-- Le card dei profili verranno inserite qui dal JS -->
            </div>
            <p id="no-results" class="text-center text-gray-500 py-10 hidden">Nessun profilo trovato.</p>
        </div>
    </div>

    <!-- Modale Inserimento/Modifica Profilo -->
    <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- Backdrop -->
        <div id="modal-backdrop" class="fixed inset-0 modal-backdrop"></div>
        
        <!-- Contenuto Modale -->
        <div class="modal-content relative bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 md:p-8">
            <h2 id="modal-title" class="text-2xl font-bold mb-6" style="color: var(--colore-primario);">Aggiungi Nuovo Profilo</h2>
            
            <form id="profile-form">
                <!-- Step 1: Controllo Nome -->
                <div id="step-1-name" class="space-y-4">
                    <label for="profile-name-check" class="block text-sm font-medium text-gray-700">Nome Profilo*</label>
                    <input type="text" id="profile-name-check" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Inserisci il nome (es. Giorgia Meloni)" required>
                    <button type="button" id="check-name-btn" class="btn-primario w-full">Verifica Nome</button>
                </div>

                <!-- Step 2: Dati Completi (Nascosto all'inizio) -->
                <div id="step-2-details" class="hidden space-y-6">
                    <!-- Nome (bloccato) -->
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-700">Nome Profilo</label>
                        <input type="text" id="profile-name" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                    </div>

                    <!-- Descrizione -->
                    <div>
                        <label for="profile-description" class="block text-sm font-medium text-gray-700">Descrizione</label>
                        <input type="text" id="profile-description" class="w-full p-2 border border-gray-300 rounded-md" placeholder="es. Presidente del Consiglio">
                    </div>

                    <!-- Canali Social -->
                    <div class="space-y-6">
                        <!-- X (Twitter) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg" style="border-color: var(--colore-secondario);">
                            <div>
                                <label for="profile-x-name" class="block text-sm font-medium text-gray-700 mb-1">Profilo X (Nome Utente)</label>
                                <input type="text" id="profile-x-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="es. TheEconomist">
                            </div>
                            <div>
                                <label for="profile-x-address" class="block text-sm font-medium text-gray-700 mb-1">Indirizzo X (Auto)</label>
                                <input type="text" id="profile-x-address" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100" placeholder="https://x.com/..." readonly>
                            </div>
                        </div>
                        
                        <!-- Facebook -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg" style="border-color: var(--colore-secondario);">
                            <div>
                                <label for="profile-facebook-name" class="block text-sm font-medium text-gray-700 mb-1">Facebook (Nome)</label>
                                <input type="text" id="profile-facebook-name" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="profile-facebook-address" class="block text-sm font-medium text-gray-700 mb-1">Facebook (Indirizzo)</label>
                                <input type="text" id="profile-facebook-address" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://facebook.com/...">
                            </div>
                        </div>

                        <!-- Instagram -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg" style="border-color: var(--colore-secondario);">
                            <div>
                                <label for="profile-instagram-name" class="block text-sm font-medium text-gray-700 mb-1">Instagram (Nome Utente)</label>
                                <input type="text" id="profile-instagram-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="es. MarioRossi">
                            </div>
                            <div>
                                <label for="profile-instagram-address" class="block text-sm font-medium text-gray-700 mb-1">Indirizzo Instagram (Auto)</label>
                                <input type="text" id="profile-instagram-address" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100" placeholder="https://www.instagram.com/..." readonly>
                            </div>
                        </div>

                        <!-- Youtube -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg" style="border-color: var(--colore-secondario);">
                            <div>
                                <label for="profile-youtube-name" class="block text-sm font-medium text-gray-700 mb-1">Youtube (Nome)</label>
                                <input type="text" id="profile-youtube-name" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="profile-youtube-address" class="block text-sm font-medium text-gray-700 mb-1">Youtube (Indirizzo)</label>
                                <input type="text" id="profile-youtube-address" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://youtube.com/...">
                            </div>
                        </div>

                        <!-- TikTok -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg" style="border-color: var(--colore-secondario);">
                            <div>
                                <label for="profile-tiktok-name" class="block text-sm font-medium text-gray-700 mb-1">Profilo TikTok (Nome Utente)</label>
                                <input type="text" id="profile-tiktok-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="es. skysport">
                            </div>
                            <div>
                                <label for="profile-tiktok-address" class="block text-sm font-medium text-gray-700 mb-1">Indirizzo TikTok (Auto)</label>
                                <input type="text" id="profile-tiktok-address" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100" placeholder="https://www.tiktok.com/@..." readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Bottoni Azione -->
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-btn" class="btn-outline">Annulla</button>
                        <button type="submit" id="save-btn" class="btn-primario">Salva Profilo</button>
                    </div>
                </div>
            </form>
            
            <!-- Bottone Chiusura Modale -->
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Modale Alert / Conferma -->
    <div id="alert-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 modal-backdrop"></div>
        <div class="modal-content relative bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="alert-title" class="text-xl font-bold mb-4" style="color: var(--colore-primario);">Titolo Alert</h2>
            <p id="alert-message" class="text-gray-600 mb-6">Messaggio alert.</p>
            <div id="alert-buttons" class="flex justify-end space-x-3">
                <!-- Bottoni inseriti da JS -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- VARIABILI GLOBALI ---
            let profiles = [];
            let editingProfileId = null;
            let currentSort = 'desc'; // 'asc', 'desc', 'az'
            let isCompactView = false;
            const DB_KEY = 'socialProfilesDB';

            // --- ELEMENTI DOM ---
            const profileList = document.getElementById('profile-list');
            const noResults = document.getElementById('no-results');
            
            // Modale
            const profileModal = document.getElementById('profile-modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addProfileBtn = document.getElementById('add-profile-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            // Form Steps
            const step1Name = document.getElementById('step-1-name');
            const step2Details = document.getElementById('step-2-details');
            const checkNameBtn = document.getElementById('check-name-btn');
            const profileNameCheck = document.getElementById('profile-name-check');

            // Form Fields
            const profileForm = document.getElementById('profile-form');
            const saveBtn = document.getElementById('save-btn');
            const fields = {
                nome: document.getElementById('profile-name'),
                description: document.getElementById('profile-description'),
                x_name: document.getElementById('profile-x-name'),
                x_address: document.getElementById('profile-x-address'),
                facebook_name: document.getElementById('profile-facebook-name'),
                facebook_address: document.getElementById('profile-facebook-address'),
                instagram_name: document.getElementById('profile-instagram-name'),
                instagram_address: document.getElementById('profile-instagram-address'),
                youtube_name: document.getElementById('profile-youtube-name'),
                youtube_address: document.getElementById('profile-youtube-address'),
                tiktok_name: document.getElementById('profile-tiktok-name'),
                tiktok_address: document.getElementById('profile-tiktok-address')
            };
            
            // Campi auto-fill
            const xNameInput = document.getElementById('profile-x-name');
            const xAddressInput = document.getElementById('profile-x-address');
            const tiktokNameInput = document.getElementById('profile-tiktok-name');
            const tiktokAddressInput = document.getElementById('profile-tiktok-address');
            const instagramNameInput = document.getElementById('profile-instagram-name');
            const instagramAddressInput = document.getElementById('profile-instagram-address');
            
            // Modale Alert
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertButtons = document.getElementById('alert-buttons');

            // Filtri e Controlli
            const filterBtn = document.getElementById('filter-btn');
            const resetFilterBtn = document.getElementById('reset-filter-btn');
            const sortAscBtn = document.getElementById('sort-asc');
            const sortDescBtn = document.getElementById('sort-desc');
            const sortAzBtn = document.getElementById('sort-az');
            const viewToggle = document.getElementById('view-toggle');
            
            // Import/Export
            const importJsonBtn = document.getElementById('import-json-btn');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const exportJsonBtn = document.getElementById('export-json-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const exportTalkwalkerBtn = document.getElementById('export-talkwalker-btn');
            const resetAppBtn = document.getElementById('reset-app-btn'); // Bottone Reset

            // --- FUNZIONI PRINCIPALI ---

            /**
             * Inizializzazione: carica dati e imposta listener
             */
            function init() {
                loadProfiles();
                addEventListeners();
                renderProfileList();
                updateSortButtons();
            }

            /**
             * Carica i profili dal localStorage
             */
            function loadProfiles() {
                try {
                    const storedProfiles = localStorage.getItem(DB_KEY);
                    if (storedProfiles) {
                        profiles = JSON.parse(storedProfiles);
                        // Pulisce eventuali dati 'category' da importazioni precedenti
                        profiles = profiles.map(p => {
                            delete p.category;
                            return p;
                        });
                    }
                } catch (e) {
                    console.error("Errore nel caricamento dei profili:", e);
                    profiles = [];
                }
            }

            /**
             * Salva i profili nel localStorage
             */
            function saveProfiles() {
                try {
                    // Assicura che 'category' non venga salvato
                    const profilesToSave = profiles.map(p => {
                        delete p.category;
                        return p;
                    });
                    localStorage.setItem(DB_KEY, JSON.stringify(profilesToSave));
                } catch (e) {
                    console.error("Errore nel salvataggio dei profili:", e);
                    showAlert("Errore", "Impossibile salvare i dati nel browser. Spazio esaurito?", 'error');
                }
            }

            /**
             * Aggiunge tutti gli event listener dell'applicazione
             */
            function addEventListeners() {
                // Chiama openProfileModal(null) per un nuovo profilo
                addProfileBtn.addEventListener('click', () => openProfileModal(null));
                
                closeModalBtn.addEventListener('click', closeProfileModal);
                modalBackdrop.addEventListener('click', closeProfileModal);
                cancelBtn.addEventListener('click', closeProfileModal);
                
                checkNameBtn.addEventListener('click', handleNameCheck);
                
                profileForm.addEventListener('submit', handleProfileFormSubmit);
                
                // Gestione autofill
                if (xNameInput) xNameInput.addEventListener('input', handleXNameChange);
                if (tiktokNameInput) tiktokNameInput.addEventListener('input', handleTikTokNameChange);
                if (instagramNameInput) instagramNameInput.addEventListener('input', handleInstagramNameChange);

                // Event Delegation per bottoni Edit/Delete sulle card
                profileList.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    
                    if (editBtn) {
                        const id = editBtn.dataset.id;
                        openProfileModal(id);
                    } else if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        handleDeleteProfile(id);
                    }
                });
                
                // Filtri e Controlli
                filterBtn.addEventListener('click', renderProfileList);
                resetFilterBtn.addEventListener('click', resetFilters);
                sortAscBtn.addEventListener('click', () => sortProfiles('asc'));
                sortDescBtn.addEventListener('click', () => sortProfiles('desc'));
                sortAzBtn.addEventListener('click', () => sortProfiles('az'));
                viewToggle.addEventListener('change', toggleView);
                
                // Import/Export
                importJsonBtn.addEventListener('change', handleImportJson);
                importExcelBtn.addEventListener('change', handleImportExcel); 
                exportJsonBtn.addEventListener('click', handleExportJson);
                exportExcelBtn.addEventListener('click', handleExportExcel);
                exportTalkwalkerBtn.addEventListener('click', handleExportTalkwalker);
                resetAppBtn.addEventListener('click', handleResetApp); // Listener Reset
            }
            
            // --- GESTIONE MODALE PROFILO ---

            /**
             * Apre la modale per aggiungere (id=null) o modificare (id=profileId)
             */
            function openProfileModal(profileId = null) {
                resetForm();
                
                if (profileId) {
                    // --- MODALITA' MODIFICA ---
                    const profile = profiles.find(p => p.id === profileId);
                    if (!profile) return;
                    
                    editingProfileId = profileId;
                    modalTitle.textContent = "Modifica Profilo";
                    
                    // Popola i campi
                    for (const key in fields) {
                        if (fields[key] && profile[key] !== undefined) {
                            fields[key].value = profile[key];
                        }
                    }
                    
                    // Mostra subito i dettagli
                    step1Name.classList.add('hidden');
                    step2Details.classList.remove('hidden');
                    
                } else {
                    // --- MODALITA' NUOVO PROFILO ---
                    editingProfileId = null;
                    modalTitle.textContent = "Aggiungi Nuovo Profilo";
                    
                    // Mostra solo lo step 1
                    step1Name.classList.remove('hidden');
                    step2Details.classList.add('hidden');
                }
                
                profileModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            /**
             * Chiude la modale profilo
             */
            function closeProfileModal() {
                profileModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                resetForm();
            }

            /**
             * Resetta il form della modale
             */
            function resetForm() {
                profileForm.reset();
                editingProfileId = null;
                profileNameCheck.value = '';
                // Resetta i campi readonly
                if(fields.x_address) fields.x_address.value = '';
                if(fields.tiktok_address) fields.tiktok_address.value = '';
                if(fields.instagram_address) fields.instagram_address.value = '';
                // Resetta lo stato dei bottoni
                resetButton(saveBtn);
                resetButton(checkNameBtn);
            }
            
            /**
             * Gestisce il controllo del nome (Step 1)
             */
            function handleNameCheck(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, "Verifico...");
                
                const name = profileNameCheck.value.trim();
                if (!name) {
                    showAlert("Errore", "Il campo nome non può essere vuoto.", 'warning');
                    resetButton(btn);
                    return;
                }
                
                const existingProfile = profiles.find(p => p.nome.toLowerCase() === name.toLowerCase());
                
                resetButton(btn);

                if (existingProfile) {
                    // Duplicato trovato
                    showConfirmation(
                        "Profilo Esistente",
                        `Esiste già un profilo chiamato "${name}". Vuoi modificarlo?`,
                        () => { 
                            // Azione "Modifica"
                            openProfileModal(existingProfile.id);
                        },
                        () => { 
                            // Azione "Annulla" (l'utente resta allo step 1)
                        }
                    );
                } else {
                    // Nome nuovo, passa allo Step 2
                    fields.nome.value = name; 
                    step1Name.classList.add('hidden');
                    step2Details.classList.remove('hidden');
                }
            }

            /**
             * Gestisce il submit del form (Salvataggio)
             */
            function handleProfileFormSubmit(e) {
                e.preventDefault();
                setButtonLoading(saveBtn, "Salvataggio...");
                
                const formData = {};
                for (const key in fields) {
                    if (fields[key]) { 
                        formData[key] = fields[key].value.trim();
                    }
                }

                try {
                    if (editingProfileId) {
                        // --- Aggiorna Profilo Esistente ---
                        const index = profiles.findIndex(p => p.id === editingProfileId);
                        if (index !== -1) {
                            profiles[index] = { 
                                ...profiles[index], 
                                ...formData 
                            };
                            delete profiles[index].category; // Sicurezza
                        } else {
                            // *** Log di errore critico se l'ID non viene trovato ***
                            console.error("ERRORE CRITICO: Impossibile trovare l'indice per l'ID di modifica:", editingProfileId, "Dati attuali:", profiles);
                            showAlert("Errore Grave", "Impossibile salvare. ID profilo non trovato. Resettare l'app o ricaricare la pagina.", "error");
                            resetButton(saveBtn);
                            return; // Interrompe l'esecuzione
                        }
                    } else {
                        // --- Crea Nuovo Profilo ---
                        const newProfile = {
                            id: `pid_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`,
                            timestamp: new Date().toISOString(),
                            ...formData
                        };
                        profiles.unshift(newProfile);
                    }
                    
                    saveProfiles();
                    setButtonSuccess(saveBtn, "Salvato!");
                    
                    setTimeout(() => {
                        closeProfileModal();
                        renderProfileList(); // Aggiorna la vista
                    }, 500);

                } catch (err) {
                    console.error("Errore nel salvataggio:", err);
                    showAlert("Errore", "Salvataggio fallito.", 'error');
                    resetButton(saveBtn);
                }
            }
            
            /**
             * Gestisce l'eliminazione di un profilo
             */
            function handleDeleteProfile(id) {
                const profile = profiles.find(p => p.id === id);
                if (!profile) return;
                
                showConfirmation(
                    "Conferma Eliminazione",
                    `Sei sicuro di voler eliminare il profilo "${profile.nome}"? L'azione è irreversibile.`,
                    () => {
                        profiles = profiles.filter(p => p.id !== id);
                        saveProfiles();
                        renderProfileList();
                        showAlert("Successo", `Profilo "${profile.nome}" eliminato.`, 'success');
                    },
                    null,
                    "Elimina", // Testo conferma
                    "Annulla"
                );
            }

            // --- RENDERING E VISTA ---

            /**
             * Renderizza la lista dei profili (filtrata e ordinata)
             */
            function renderProfileList() {
                profileList.innerHTML = '';
                const data = getFilteredData();
                
                if (data.length === 0) {
                    noResults.classList.remove('hidden');
                    profileList.classList.add('hidden');
                } else {
                    noResults.classList.add('hidden');
                    profileList.classList.remove('hidden');
                    
                    // Applica la classe corretta per la vista
                    profileList.className = isCompactView ? 'card-grid-compact' : 'card-grid-full';
                    
                    data.forEach(profile => {
                        const card = isCompactView ? createProfileCardCompact(profile) : createProfileCardFull(profile);
                        profileList.appendChild(card);
                    });
                }
            }

            /**
             * Crea una card in formato COMPATTO
             */
            function createProfileCardCompact(p) {
                const card = document.createElement('div');
                card.className = 'profile-card-compact';
                
                card.innerHTML = `
                    <div>
                        <div class="mb-2">
                            <h3 class="text-lg font-bold" style="color: var(--colore-primario);">${p.nome || 'Senza Nome'}</h3>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${p.description || 'Nessuna descrizione.'}</p>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3 mt-3">
                        <span class="text-xs text-gray-400" title="${new Date(p.timestamp).toLocaleString()}">
                            ID: ...${p.id.slice(-6)}
                        </span>
                        <div class="flex space-x-2">
                            <button class="edit-btn p-1 text-gray-400 hover:text-blue-600" data-id="${p.id}" title="Modifica">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7.172l5-5L14.828 7 10 12H5zM15 13H5a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1z"/></svg>
                            </button>
                            <button class="delete-btn p-1 text-gray-400 hover:text-red-600" data-id="${p.id}" title="Elimina">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd"/></svg>
                            </button>
                        </div>
                    </div>
                `;
                return card;
            }

            /**
             * Crea una card in formato COMPLETO
             */
            function createProfileCardFull(p) {
                const card = document.createElement('div');
                card.className = 'profile-card-full';
                
                const dataInserimento = new Date(p.timestamp).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });

                // Crea link cliccabili
                const xLink = p.x_address ? `<a href="${p.x_address}" target="_blank" class="text-blue-600 hover:underline">Vedi (${p.x_name || '...'})</a>` : 'Non presente';
                const facebookLink = p.facebook_address ? `<a href="${p.facebook_address}" target="_blank" class="text-blue-600 hover:underline">Vedi (${p.facebook_name || '...'})</a>` : 'Non presente';
                const instagramLink = p.instagram_address ? `<a href="${p.instagram_address}" target="_blank" class="text-blue-600 hover:underline">Vedi (${p.instagram_name || '...'})</a>` : 'Non presente';
                const youtubeLink = p.youtube_address ? `<a href="${p.youtube_address}" target="_blank" class="text-blue-600 hover:underline">Vedi (${p.youtube_name || '...'})</a>` : 'Non presente';
                const tiktokLink = p.tiktok_address ? `<a href="${p.tiktok_address}" target="_blank" class="text-blue-600 hover:underline">Vedi (${p.tiktok_name || '...'})</a>` : 'Non presente';

                card.innerHTML = `
                    <div class="card-header flex flex-col md:flex-row md:justify-between md:items-start">
                        <div>
                            <h3 class="text-2xl font-bold" style="color: var(--colore-primario);">${p.nome || 'Senza Nome'}</h3>
                            <p class="text-gray-600 text-md">${p.description || 'Nessuna descrizione.'}</p>
                        </div>
                        <div class="mt-2 md:mt-0 md:text-right">
                            <span class="block text-xs text-gray-400 mt-2" title="${new Date(p.timestamp).toLocaleString()}">
                                Inserito: ${dataInserimento}
                            </span>
                        </div>
                    </div>
                    
                    <div class="social-links-grid grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mt-4 text-sm">
                        <div><strong class="text-gray-600">X (Twitter):</strong> ${xLink}</div>
                        <div><strong class="text-gray-600">Facebook:</strong> ${facebookLink}</div>
                        <div><strong class="text-gray-600">Instagram:</strong> ${instagramLink}</div>
                        <div><strong class="text-gray-600">Youtube:</strong> ${youtubeLink}</div>
                        <div><strong class="text-gray-600">TikTok:</strong> ${tiktokLink}</div>
                    </div>
                    
                    <div class="flex justify-end items-center border-t pt-4 mt-6 space-x-3">
                        <button class="edit-btn btn-outline py-2 px-4 text-sm flex items-center space-x-1" data-id="${p.id}" title="Modifica">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7.172l5-5L14.828 7 10 12H5zM15 13H5a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1z"/></svg>
                            <span>Modifica</span>
                        </button>
                        <button class="delete-btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md text-sm flex items-center space-x-1" data-id="${p.id}" title="Elimina">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd"/></svg>
                            <span>Elimina</span>
                        </button>
                    </div>
                `;
                return card;
            }

            /**
             * Gestisce il cambio di vista (compatta/completa)
             */
            function toggleView(e) {
                isCompactView = e.target.checked;
                renderProfileList(); // Ridisegna la lista con la nuova vista
            }

            // --- FILTRI E ORDINAMENTO ---

            /**
             * Applica i filtri e l'ordinamento
             */
            function getFilteredData(shouldSort = true) {
                const searchText = document.getElementById('search-text').value.toLowerCase();
                const searchDateStart = document.getElementById('search-date-start').value;
                const searchDateEnd = document.getElementById('search-date-end').value;
                const searchChannel = document.getElementById('search-channel').value;

                let filtered = profiles.filter(p => {
                    // Filtro Data
                    if (searchDateStart) {
                        const profileDate = new Date(p.timestamp);
                        const startDate = new Date(searchDateStart);
                        if (profileDate < startDate) return false;
                    }
                    if (searchDateEnd) {
                        const profileDate = new Date(p.timestamp);
                        const endDate = new Date(searchDateEnd);
                        endDate.setHours(23, 59, 59); // Include tutto il giorno finale
                        if (profileDate > endDate) return false;
                    }

                    // Filtro Canale (verifica che il campo esista e non sia vuoto)
                    if (searchChannel && !p[searchChannel]) return false;

                    // Filtro Testuale (con logica booleana)
                    if (searchText) {
                        return checkBooleanSearch(p, searchText);
                    }
                    
                    return true;
                });
                
                // Ordinamento (se richiesto)
                if (shouldSort) {
                    if (currentSort === 'asc') {
                        filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    } else if (currentSort === 'desc') {
                        filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    } else if (currentSort === 'az') {
                        filtered.sort((a, b) => a.nome.localeCompare(b.nome, 'it', { sensitivity: 'base' }));
                    }
                }
                
                return filtered;
            }
            
            /**
             * Resetta tutti i campi filtro e ridisegna la lista
             */
            function resetFilters() {
                document.getElementById('search-text').value = '';
                document.getElementById('search-date-start').value = '';
                document.getElementById('search-date-end').value = '';
                document.getElementById('search-channel').value = '';
                renderProfileList();
            }

            /**
             * Gestisce la logica di ordinamento
             */
            function sortProfiles(criteria) {
                currentSort = criteria;
                renderProfileList(); // Ridisegna la lista applicando filtri E nuovo ordinamento
                updateSortButtons();
            }

            /**
             * Aggiorna lo stile dei bottoni di ordinamento
             */
            function updateSortButtons() {
                sortAscBtn.classList.toggle('active-sort', currentSort === 'asc');
                sortDescBtn.classList.toggle('active-sort', currentSort === 'desc');
                sortAzBtn.classList.toggle('active-sort', currentSort === 'az');
            }
            
            /**
             * Interpreta la ricerca booleana
             * (Semplificata: supporta E, O, NON)
             */
            function checkBooleanSearch(profile, text) {
                const profileText = [
                    profile.nome,
                    profile.description,
                    profile.x_name,
                    profile.facebook_name,
                    profile.instagram_name,
                    profile.youtube_name,
                    profile.tiktok_name
                ].join(' ').toLowerCase();

                // Logica 'E' (AND)
                if (text.includes(' e ') || text.includes(' and ')) {
                    const terms = text.split(/ e | and /);
                    return terms.every(term => profileText.includes(term.trim()));
                }
                
                // Logica 'NON' (NOT)
                if (text.includes(' non ') || text.includes(' not ')) {
                    const parts = text.split(/ non | not /);
                    const mustHave = parts[0].trim();
                    const mustNotHave = parts[1].trim();
                    if (!mustHave) return !profileText.includes(mustNotHave);
                    return profileText.includes(mustHave) && !profileText.includes(mustNotHave);
                }

                // Logica 'O' (OR) - Default se non ci sono 'E' o 'NON'
                const terms = text.split(/ o | or | /); // Spazio o 'o'
                return terms.some(term => term && profileText.includes(term.trim()));
            }

            // --- IMPORT / EXPORT ---

            /**
             * Gestisce l'importazione da file JSON
             */
            function handleImportJson(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!Array.isArray(importedData)) {
                            throw new Error("Il file JSON non è un array.");
                        }
                        
                        // Valida la struttura (controllo base)
                        if (importedData.length > 0 && (!importedData[0].id || !importedData[0].nome)) {
                             throw new Error("Struttura dati non valida.");
                        }
                        
                        // Pulisce i dati importati da 'category'
                        const cleanedData = importedData.map(p => {
                            delete p.category;
                            return p;
                        });

                        // Chiede conferma per unione o sovrascrittura
                        showConfirmation(
                            "Importa Dati",
                            "Vuoi unire i dati importati con quelli esistenti o sovrascrivere l'intero database?",
                            () => { // Azione "Unisci"
                                const merged = [...profiles];
                                cleanedData.forEach(newProfile => {
                                    const index = merged.findIndex(p => p.id === newProfile.id);
                                    if (index !== -1) {
                                        merged[index] = newProfile; // Aggiorna
                                    } else {
                                        merged.push(newProfile); // Aggiunge
                                    }
                                });
                                profiles = merged;
                                saveAndRender("Dati uniti con successo.");
                            },
                            () => { // Azione "Sovrascrivi"
                                profiles = cleanedData;
                                saveAndRender("Database sovrascritto con successo.");
                            },
                            "Unisci",
                            "Sovrascrivi"
                        );

                    } catch (err) {
                        console.error("Errore importazione JSON:", err);
                        showAlert("Importazione Fallita", `Errore: ${err.message}`, 'error');
                    } finally {
                        // Resetta l'input file per permettere di ricaricare lo stesso file
                        e.target.value = null;
                    }
                };
                reader.readAsText(file);
            }
            
            /**
             * Gestisce l'importazione da file Excel
             */
            function handleImportExcel(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = event.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (!Array.isArray(jsonData)) {
                            throw new Error("Il file Excel non ha prodotto un array.");
                        }
                        
                        if (jsonData.length === 0) {
                            throw new Error("Il file Excel è vuoto.");
                        }

                        // Mappa le colonne Excel ai campi del profilo
                        const importedProfiles = jsonData.map(row => {
                            if (!row["Nome"]) return null; // "Nome" è obbligatorio
                            
                            return {
                                id: row["ID"] || `pid_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`,
                                timestamp: row["Data Inserimento"] ? new Date(row["Data Inserimento"]).toISOString() : new Date().toISOString(),
                                nome: row["Nome"],
                                description: row["Descrizione"] || '',
                                x_name: row["X Nome"] || '',
                                x_address: row["X Indirizzo"] || '',
                                facebook_name: row["Facebook Nome"] || '',
                                facebook_address: row["Facebook Indirizzo"] || '',
                                instagram_name: row["Instagram Nome"] || '',
                                instagram_address: row["Instagram Indirizzo"] || '',
                                youtube_name: row["Youtube Nome"] || '',
                                youtube_address: row["Youtube Indirizzo"] || '',
                                tiktok_name: row["TikTok Nome"] || '',
                                tiktok_address: row["TikTok Indirizzo"] || '',
                            };
                        }).filter(p => p !== null); // Rimuove righe non valide

                        if (importedProfiles.length === 0) {
                            throw new Error("Nessuna riga valida trovata. Assicurati che la colonna 'Nome' sia presente e corrisponda al formato di esportazione.");
                        }

                        // Usa la stessa modale di conferma del JSON
                        showConfirmation(
                            "Importa Dati Excel",
                            `Trovati ${importedProfiles.length} profili. Vuoi unire o sovrascrivere?`,
                            () => { // Azione "Unisci"
                                const merged = [...profiles];
                                importedProfiles.forEach(newProfile => {
                                    const index = merged.findIndex(p => p.id === newProfile.id);
                                    if (index !== -1) {
                                        merged[index] = newProfile; // Aggiorna
                                    } else {
                                        merged.push(newProfile); // Aggiunge
                                    }
                                });
                                profiles = merged;
                                saveAndRender("Dati uniti con successo.");
                            },
                            () => { // Azione "Sovrascrivi"
                                profiles = importedProfiles;
                                saveAndRender("Database sovrascritto con successo.");
                            },
                            "Unisci",
                            "Sovrascrivi"
                        );

                    } catch (err) {
                        console.error("Errore importazione Excel:", err);
                        showAlert("Importazione Fallita", `Errore: ${err.message}`, 'error');
                    } finally {
                        e.target.value = null; // Resetta input
                    }
                };
                reader.readAsBinaryString(file);
            }
            
            function saveAndRender(successMessage) {
                saveProfiles();
                renderProfileList();
                showAlert("Successo", successMessage, 'success');
            }

            /**
             * Esporta l'intero DB in JSON
             */
            function handleExportJson(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, "Preparo...");
                
                try {
                    const dataStr = JSON.stringify(profiles, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const dateStr = new Date().toISOString().split('T')[0];
                    
                    createDownloadLink(blob, `social_db_export_${dateStr}.json`);
                    setButtonSuccess(btn, "Esportato!");
                    
                } catch (err) {
                    console.error("Errore esportazione JSON:", err);
                    showAlert("Errore", "Esportazione fallita.", 'warning');
                    resetButton(btn);
                }
            }

            /**
             * Esporta i risultati filtrati in Excel
             */
            function handleExportExcel(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, "Preparo...");

                const filteredData = getFilteredData();
                
                if (filteredData.length === 0) {
                    showAlert("Nessun Dato", "Nessun risultato filtrato da esportare.", 'warning');
                    resetButton(btn);
                    return;
                }

                try {
                    // Prepara i dati per SheetJS
                    const dataToExport = filteredData.map(p => ({
                        "Nome": p.nome,
                        "Descrizione": p.description,
                        "Data Inserimento": new Date(p.timestamp).toISOString(),
                        "X Nome": p.x_name,
                        "X Indirizzo": p.x_address,
                        "Facebook Nome": p.facebook_name,
                        "Facebook Indirizzo": p.facebook_address,
                        "Instagram Nome": p.instagram_name,
                        "Instagram Indirizzo": p.instagram_address,
                        "Youtube Nome": p.youtube_name,
                        "Youtube Indirizzo": p.youtube_address,
                        "TikTok Nome": p.tiktok_name,
                        "TikTok Indirizzo": p.tiktok_address,
                        "ID": p.id
                    }));

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Profili Filtrati");
                    
                    const dateStr = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `filtro_profili_${dateStr}.xlsx`);
                    
                    setButtonSuccess(btn, "Esportato!");
                } catch (err) {
                    console.error("Errore esportazione Excel:", err);
                    showAlert("Errore", "Esportazione fallita.", 'warning');
                    resetButton(btn);
                }
            }

            /**
             * Esporta i risultati filtrati in formato Talkwalker
             */
            function handleExportTalkwalker(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, "Preparo...");
                
                const filteredData = getFilteredData();
                
                if (filteredData.length === 0) {
                    showAlert("Nessun Dato", "Nessun risultato filtrato da esportare.", 'warning');
                    resetButton(btn);
                    return;
                }
                
                // Crea la stringa: (author:"nome1" OR author:"nome2")
                const authors = filteredData.flatMap(p => {
                    const names = [];
                    // Pulisce i nomi utente da @ o spazi
                    const cleanName = (name) => name ? name.replace(/@/g, '').replace(/\s/g, '').trim() : '';
                    
                    if (p.x_name) names.push(cleanName(p.x_name));
                    if (p.facebook_name) names.push(cleanName(p.facebook_name));
                    if (p.instagram_name) names.push(cleanName(p.instagram_name));
                    if (p.youtube_name) names.push(cleanName(p.youtube_name));
                    if (p.tiktok_name) names.push(cleanName(p.tiktok_name));
                    
                    // Formatta ogni nome
                    return names.filter(name => name).map(name => `author:"${name.replace(/"/g, '')}"`);
                });

                // Rimuove eventuali duplicati
                const uniqueAuthors = [...new Set(authors)];
                
                if (uniqueAuthors.length === 0) {
                    showAlert("Nessun Dato Valido", "Nessuno dei profili filtrati ha un Nome Account (X, FB, IG, etc.) valido.", 'warning');
                    resetButton(btn);
                    return;
                }

                const talkwalkerString = `(${uniqueAuthors.join(' OR ')})`;
                
                try {
                    const blob = new Blob([talkwalkerString], { type: 'text/plain;charset=utf-8' });
                    const dateStr = new Date().toISOString().split('T')[0];
                    createDownloadLink(blob, `filtro_talkwalker_${dateStr}.txt`);
                    
                    setButtonSuccess(btn, "Esportato!");
                } catch (err) {
                    console.error("Errore esportazione Talkwalker:", err);
                    showAlert("Errore", "Esportazione fallita.", 'warning');
                    resetButton(btn);
                }
            }
            
            /**
             * (NUOVO) Gestisce il reset dell'applicazione
             */
            function handleResetApp() {
                showConfirmation(
                    "Resetta Applicazione",
                    "Sei sicuro di voler resettare l'applicazione? Tutti i dati salvati (profili) verranno eliminati definitivamente.",
                    () => {
                        try {
                            localStorage.removeItem(DB_KEY);
                            profiles = [];
                            showAlert("Reset Completato", "L'applicazione è stata resettata. La pagina verrà ricaricata.", 'success');
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } catch (e) {
                            console.error("Errore nel reset:", e);
                            showAlert("Errore", "Impossibile resettare l'applicazione.", 'error');
                        }
                    },
                    null,
                    "Resetta Tutto", // Testo conferma
                    "Annulla"
                );
            }
            
            // --- HANDLERS MODALI ---

            /**
             * Mostra un modale di alert semplice (tipo 'OK')
             */
            function showAlert(title, message, type = 'info') {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                
                // Colora il titolo in base al tipo
                if (type === 'error' || type === 'warning') {
                    alertTitle.style.color = '#DC2626'; // red-600
                } else if (type === 'success') {
                    alertTitle.style.color = '#16A34A'; // green-600
                } else {
                    alertTitle.style.color = 'var(--colore-primario)';
                }

                alertButtons.innerHTML = ''; // Rimuove bottoni precedenti
                const okButton = document.createElement('button');
                okButton.className = 'btn-primario';
                okButton.textContent = 'OK';
                okButton.onclick = closeAlertModal;
                
                alertButtons.appendChild(okButton);
                alertModal.classList.remove('hidden');
            }

            /**
             * Mostra un modale di conferma (es. "Sì", "No")
             */
            function showConfirmation(title, message, onConfirm, onCancel = null, confirmText = "Conferma", cancelText = "Annulla") {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertTitle.style.color = 'var(--colore-primario)';
                
                alertButtons.innerHTML = ''; // Rimuove bottoni precedenti

                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn-outline';
                cancelButton.textContent = cancelText;
                cancelButton.onclick = () => {
                    closeAlertModal();
                    if (onCancel) onCancel();
                };
                
                const confirmButton = document.createElement('button');
                // Colore speciale per conferma distruttiva
                if (confirmText === "Resetta Tutto" || confirmText === "Elimina" || confirmText === "Sovrascrivi") {
                    confirmButton.className = 'btn-danger';
                } else {
                    confirmButton.className = 'btn-primario';
                }
                
                confirmButton.textContent = confirmText;
                confirmButton.onclick = () => {
                    closeAlertModal();
                    if (onConfirm) onConfirm();
                };
                
                alertButtons.appendChild(cancelButton);
                alertButtons.appendChild(confirmButton);
                alertModal.classList.remove('hidden');
            }

            /**
             * Chiude il modale di alert/conferma
             */
            function closeAlertModal() {
                alertModal.classList.add('hidden');
            }
            
            // --- HANDLERS AUTO-FILL ---

            function handleXNameChange(e) {
                const name = e.target.value.trim().replace('@', '');
                if (xAddressInput) xAddressInput.value = name ? `https://x.com/${name}` : '';
            }
            
            function handleTikTokNameChange(e) {
                let name = e.target.value.trim().replace('@', '');
                // Assicura che @ sia presente per TikTok
                if (name && !name.startsWith('@')) {
                    name = `@${name}`;
                }
                if (tiktokAddressInput) tiktokAddressInput.value = name ? `https://www.tiktok.com/${name}` : '';
            }
            
            function handleInstagramNameChange(e) {
                let name = e.target.value.trim().replace('@', '');
                if (instagramAddressInput) instagramAddressInput.value = name ? `https://www.instagram.com/${name}/` : '';
            }

            // --- FUNZIONI HELPER ---
            
            function setButtonLoading(button, text) {
                if (!button) return;
                button.disabled = true;
                const originalText = button.innerHTML;
                button.dataset.originalText = originalText;
                button.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>${text}</span>
                `;
                // Se il bottone è primario o secondario, mantiene lo stile
                if(button.classList.contains('btn-primario') || button.classList.contains('btn-secondario')) {
                    button.style.opacity = '0.7';
                }
            }

            function resetButton(button) {
                if (!button) return;
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
                button.style.opacity = '1';
            }
            
            function setButtonSuccess(button, text) {
                if (!button) return;
                button.disabled = true;
                button.innerHTML = `<span>${text}</span>`;
                // Cambia colore temporaneamente
                let originalBg = '';
                let originalBorder = '';
                
                if(button.classList.contains('btn-primario')) {
                    originalBg = 'var(--colore-primario)';
                    originalBorder = 'var(--colore-primario)';
                } else if (button.classList.contains('btn-secondario')) {
                    originalBg = 'var(--colore-secondario)';
                    originalBorder = 'var(--colore-secondario)';
                } else if (button.classList.contains('btn-outline')) {
                    originalBg = 'white';
                    originalBorder = 'var(--colore-primario)';
                }

                button.style.backgroundColor = '#16A34A'; // Verde
                button.style.borderColor = '#16A34A';
                button.style.color = 'white'; // Assicura testo bianco su verde
                
                setTimeout(() => {
                    resetButton(button);
                    // Ripristina colore originale
                    button.style.backgroundColor = originalBg;
                    button.style.borderColor = originalBorder;
                    if(button.classList.contains('btn-outline')) {
                        button.style.color = 'var(--colore-primario)'; // Ripristina colore testo outline
                    } else if (button.classList.contains('btn-secondario')) {
                        button.style.color = '#333'; // Ripristina colore testo secondario
                    }
                }, 1500);
            }
            
            function createDownloadLink(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- AVVIO APPLICAZIONE ---
            init();
        });
    </script>
</body>
</html>

